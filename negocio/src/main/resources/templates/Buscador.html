<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inmobiliarias Paqui - Buscador</title>
    <link rel="stylesheet" th:href="@{/css/styleBuscador.css}" />
  </head>

  <body>
    <header>
      <div
        class="logo"
        role="link"
        tabindex="0"
        aria-label="Ir a inicio"
        onclick="location.href='/'"
        onkeydown="if(event.key==='Enter'||event.key===' '){location.href='/';}"
      >
        Inmobiliarias Paqui
      </div>
      <div class="search-bar" role="search">
        <input id="q" type="text" placeholder="Ciudad" aria-label="Ciudad" />
        <input id="checkin" type="date" aria-label="Fecha de entrada" />
        <input id="checkout" type="date" aria-label="Fecha de salida" />
        <div class="people-counter" aria-label="Personas">
          <button type="button" id="minusPerson" aria-label="Quitar persona">
            -
          </button>
          <span id="peopleCount" aria-live="polite">2</span>
          <button type="button" id="plusPerson" aria-label="Añadir persona">
            +
          </button>
        </div>
        <button id="searchBtn">Buscar</button>
      </div>
      <div>
        <button class="btn-register" onclick="window.location.href='/register'">
          Iniciar sesión o registrarse
        </button>
      </div>
    </header>

    <!-- Sidebar fijo -->
    <aside class="filters" aria-label="Filtros">
      <h3>Filtrar resultados</h3>

      <div class="filter-group">
        <div style="font-size: 13px; margin-bottom: 6px">Tipo</div>
        <label
          ><input type="checkbox" class="filter-type" value="hotel" checked />
          Hotel</label
        >
        <label
          ><input
            type="checkbox"
            class="filter-type"
            value="apartamento"
            checked
          />
          Apartamento</label
        >
      </div>

      <div class="filter-group">
        <div style="font-size: 13px; margin-bottom: 6px">Precio máximo (€)</div>
        <input
          type="range"
          id="maxPrice"
          min="0"
          max="1000"
          value="1000"
          step="1"
        />
        <div style="font-size: 12px; color: #555">
          Hasta: <span id="maxPriceVal">1000</span> €
        </div>
      </div>

      <div class="filter-group">
        <div style="font-size: 13px; margin-bottom: 6px">Puntuación mínima</div>
        <input
          type="range"
          id="minRating"
          min="0"
          max="5"
          value="0"
          step="0.5"
        />
        <div style="font-size: 12px; color: #555">
          Desde: <span id="minRatingVal">0</span> ⭐
        </div>
      </div>

      <div class="filter-group">
        <div style="font-size: 13px; margin-bottom: 6px">Ordenar</div>
        <select id="sortBy">
          <option value="recommend">Recomendados</option>
          <option value="price_asc">Precio (bajo → alto)</option>
          <option value="price_desc">Precio (alto → bajo)</option>
          <option value="rating">Puntuación</option>
        </select>
      </div>
    </aside>

    <!-- Contenido principal -->
    <div class="main-wrapper">
      <main class="container">
        <section>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <div id="resultsCount" style="font-weight: 700">
              Mostrando 0 alojamientos
            </div>
          </div>
          <div class="results" id="resultsList"></div>
        </section>
      </main>
    </div>

    <script>
      const data = [
        {
          id: 1,
          type: "hotel",
          ciudad: "Madrid",
          title: "Hotel Centro Madrid",
          price: 120,
          rating: 4.5,
          img: "https://picsum.photos/320/200?random=1",
          distance: 0.8,
          capacity: 2,
        },
        {
          id: 2,
          type: "apartamento",
          ciudad: "Murcia",
          title: "Apto. Moderno Chamartín",
          price: 85,
          rating: 4.0,
          img: "https://picsum.photos/320/200?random=2",
          distance: 2.1,
          capacity: 4,
        },
        {
          id: 3,
          type: "hotel",
          ciudad: "Málaga",
          title: "Hotel con encanto",
          price: 200,
          rating: 4.5,
          img: "https://picsum.photos/320/200?random=3",
          distance: 1.3,
          capacity: 3,
        },
        {
          id: 4,
          type: "apartamento",
          ciudad: "Munich",
          title: "Estudio Centro",
          price: 60,
          rating: 4.0,
          img: "https://picsum.photos/320/200?random=4",
          distance: 0.5,
          capacity: 2,
        },
        {
          id: 5,
          type: "hotel",
          ciudad: "Valencia",
          title: "Hotel Playa Valencia",
          price: 150,
          rating: 3.5,
          img: "https://picsum.photos/320/200?random=5",
          distance: 3.0,
          capacity: 5,
        },
      ];

      // Elements
      const resultsList = document.getElementById("resultsList");
      const resultsCount = document.getElementById("resultsCount");
      const maxPrice = document.getElementById("maxPrice");
      const maxPriceVal = document.getElementById("maxPriceVal");
      const sortBy = document.getElementById("sortBy");
      const searchInput = document.getElementById("q");
      const minRating = document.getElementById("minRating");
      const minRatingVal = document.getElementById("minRatingVal");
      const minusBtn = document.getElementById("minusPerson");
      const plusBtn = document.getElementById("plusPerson");
      const peopleCountEl = document.getElementById("peopleCount");
      const checkinEl = document.getElementById("checkin");
      const checkoutEl = document.getElementById("checkout");
      const searchBtn = document.getElementById("searchBtn");

      // Estado controlado SOLO al pulsar "Buscar"
      let count = 2;
      let lastQuery = "";
      let lastCheckin = "";
      let lastCheckout = "";

  /** Convierte una distancia en km a un texto amigable para el usuario.
 * @param {number} km - La distancia en kilómetros.
 * @returns {string} El texto formateado.
 */
function formatDistance(km) {
    // Si la distancia es un número, la formateamos. Si ya es un texto, lo devolvemos tal cual.
    if (typeof km !== 'number') {
        return km;
    }
    if (km === 0) return "en el centro";
    if (km < 0.1) return "a 100 m del centro";
    // .toFixed(1) limita a un decimal, ej: 0.8
    return `a ${km.toFixed(1)} km del centro`;
}


/**
 * Pinta la lista de resultados en el DOM.
 * @param {Array<Object>} items - El array de alojamientos a mostrar.
 */
function renderList(items) {
    resultsList.innerHTML = ""; // Limpia la lista anterior

    if (!items || !items.length) {
        // Muestra un mensaje si no hay resultados
        resultsList.innerHTML =
            '<div class="no-results-card">No hay alojamientos que coincidan con tu búsqueda.</div>';
        resultsCount.textContent = "Mostrando 0 alojamientos";
        return;
    }

    resultsCount.textContent = `Mostrando ${items.length} alojamientos`;

    for (const it of items) {
        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
            <img src="${it.img}" alt="${it.title}" loading="lazy" />
            <div class="info">
                <div class="title">${it.title}</div>
                <div class="meta">⭐ ${it.rating} · ${formatDistance(it.distance)}</div>
                <div class="details">Tipo: ${it.type} · Ciudad: ${it.ciudad} · Capacidad: ${it.capacity} pers.</div>
            </div>
            <div class="actions">
                <div class="price">${it.price} €</div>
                <button class="btn-book" 
                        aria-label="Ver disponibilidad de ${it.title}" 
                        onclick="book(${it.id})">
                    Ver disponibilidad
                </button>
            </div>
        `;
        resultsList.appendChild(card);
    }
}

      function applyFilters() {
        // Lee el estado que SOLO se actualiza al pulsar Buscar
        const checkedTypes = Array.from(
          document.querySelectorAll(".filter-type:checked")
        ).map((n) => n.value);
        const max = +maxPrice.value;
        const minR = +minRating.value;

        let filtered = data.filter(
          (d) =>
            checkedTypes.includes(d.type) &&
            d.price <= max &&
            d.rating >= minR &&
            d.ciudad.toLowerCase().includes(lastQuery) &&
            d.capacity >= count
          // Si en el futuro filtras por fechas, usa lastCheckin/lastCheckout aquí
        );

        const s = sortBy.value;
        if (s === "price_asc") filtered.sort((a, b) => a.price - b.price);
        if (s === "price_desc") filtered.sort((a, b) => b.price - a.price);
        if (s === "rating") filtered.sort((a, b) => b.rating - a.rating);

        renderList(filtered);
      }

      // Personas: ACTUALIZA SOLO EL CONTADOR VISUAL; NO FILTRA EN VIVO
      function updatePeople() {
        peopleCountEl.textContent = count;
      }
      minusBtn.addEventListener("click", () => {
        if (count > 1) {
          count--;
          updatePeople();
        }
      });
      plusBtn.addEventListener("click", () => {
        count++;
        updatePeople();
      });
      updatePeople();

      // Click en Buscar: aquí se sincroniza todo y se filtra
      searchBtn.addEventListener("click", () => {
        // Sincroniza estado controlado
        lastQuery = (searchInput.value || "").trim().toLowerCase();
        lastCheckin = checkinEl.value || "";
        lastCheckout = checkoutEl.value || "";

        // Sanea fechas (si el usuario puso mal el rango)
        if (lastCheckin && lastCheckout && lastCheckin > lastCheckout) {
          lastCheckout = "";
          checkoutEl.value = ""; // refleja la corrección en UI
        }

        applyFilters();
        // (Opcional) actualiza la URL con los parámetros de búsqueda
        const p = new URLSearchParams(location.search);
        if (lastQuery) p.set("q", lastQuery);
        else p.delete("q");
        p.set("people", String(count));
        if (lastCheckin) p.set("checkin", lastCheckin);
        else p.delete("checkin");
        if (lastCheckout) p.set("checkout", lastCheckout);
        else p.delete("checkout");
        history.replaceState(null, "", `${location.pathname}?${p.toString()}`);
      });

      // Enter dentro de la barra de búsqueda dispara "Buscar"
      document.querySelector(".search-bar").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          searchBtn.click();
        }
      });

      // Filtros de la SIDEBAR siguen siendo en vivo (checkbox/range/select)
      maxPrice.addEventListener("input", () => {
        maxPriceVal.textContent = maxPrice.value;
        applyFilters();
      });
      minRating.addEventListener("input", () => {
        minRatingVal.textContent = minRating.value;
        applyFilters();
      });
      sortBy.addEventListener("change", applyFilters);
      document
        .querySelectorAll(".filter-type")
        .forEach((cb) => cb.addEventListener("change", applyFilters));

      // Precarga desde la URL (solo una vez al inicio) y primer render
      (function hydrateFromParams() {
        const p = new URLSearchParams(location.search);
        const q = p.get("q") || "";
        const type = p.get("type");
        const people = parseInt(p.get("people") || "", 10);
        const cIn = p.get("checkin") || "";
        const cOut = p.get("checkout") || "";

        if (q) {
          searchInput.value = q;
          lastQuery = q.toLowerCase();
        }
        if (!isNaN(people) && people > 0) {
          count = people;
          updatePeople();
        }
        if (cIn) {
          checkinEl.value = cIn;
          lastCheckin = cIn;
        }
        if (cOut) {
          checkoutEl.value = cOut;
          lastCheckout = cOut;
        }

        if (type) {
          document.querySelectorAll(".filter-type").forEach((cb) => {
            cb.checked = cb.value === type;
          });
        }

        maxPriceVal.textContent = maxPrice.value;
        minRatingVal.textContent = minRating.value;

        if (
          checkinEl.value &&
          checkoutEl.value &&
          checkinEl.value > checkoutEl.value
        ) {
          checkoutEl.value = "";
          lastCheckout = "";
        }

        applyFilters(); // pinta resultados iniciales con lo que haya en URL
      })();

      function book(id) {
        const selected = data.find((item) => item.id === id);
        if (selected) {
          localStorage.setItem("selectedLodging", JSON.stringify(selected));
          window.location.href = "/alojamientos/detalleAlojamientos"; // <- aquí
        }
      }
    </script>
  </body>
</html>
